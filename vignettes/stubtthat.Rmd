---
title: "stubthat - Stubs for unit testing in R"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{stubthat}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = T, comment = "#>")
library(stubthat)
```


# Introduction
stubthat package provides stubs for use while unit testing in R. The API is highly inspired by the [Sinon.js](http://sinonjs.org/). This package is meant to be used along with the [testthat](https://cran.r-project.org/web/packages/testthat/index.html) package, specifically the 'with_mock' function.

# Usage
There are three main steps to the create a stub of a function - 

1. Invoke the *stub* function with the function that needs to be mocked
```{r}
jedi_or_sith <- function(x) return('No one')
jedi_or_sith_stub <- stub(jedi_or_sith)
```
2. Define the behavior. This is explained in detail in the next section.
```{r}
jedi_or_sith_stub$withArgs(x = 'Luke')$returns('Jedi')
```
3. Build the stub.
```{r results='asis'}
jedi_or_sith_stub <- jedi_or_sith_stub$build()
```

Once the stub is built, you can use the returned function.
```{r}
jedi_or_sith('Luke')
jedi_or_sith_stub('Luke')
```

Stubs are generally used while testing. Here is an example:
```{r}
library('httr')

check_api_endpoint_status <- function(url) {
  response <- GET(url)
  response_status <- status_code(response)
  ifelse(response_status == 200, 'up', 'down')
}
```
This function *check_api_endpoint_status* should make a *GET* request to the specified url and it should return *'up'* if the status code is *'200'*. Return *'down'* otherwise.

Using stubs, without accessing any external source, the function can be tested as shown below:
```{r}
stub_of_get <- stub(GET)
stub_of_get$withArgs(url = 'good url')$returns('good response')
stub_of_get$withArgs(url = 'bad url')$returns('bad response')
stub_of_get <- stub_of_get$build()

stub_of_status_code <- stub(status_code)
stub_of_status_code$withArgs(x = 'good response')$returns(200)
stub_of_status_code$withArgs(x = 'bad response')$returns(400)
stub_of_status_code <- stub_of_status_code$build()

library('testthat')
with_mock(GET = stub_of_get, status_code = stub_of_status_code,
          expect_equal(check_api_endpoint_status('good url'), 'up'))

with_mock(GET = stub_of_get, status_code = stub_of_status_code,
          expect_equal(check_api_endpoint_status('bad url'), 'down'))
```


# Behaviors
## Simple
````stub$returns(data.frame(x = 1, y = 2))````

This will always return the specified object irrespective of the inputs.

````stub$throws('there is an error')````

This will always throw an error with the specified message irrespective of the inputs.

````stub$expects(a = 1, b = 2, d = 3, c = 4)````

This will check the incoming arguements for the specifed set of arguments. Throws error if there is a mismatch. Returns null if matched.

## withExactArgs
````stub$withExactArgs(a = 1, b = 2, d = 3, c = 4)$returns(10)````

If the function is called with **exact** set of expected arguments, then the specified object will be returned.

````stub$withExactArgs(a = 1, b = 2, d = 3, c = 4)$throws('err_msg')````

If the function is called with **exact** set of expected arguments, then an error is thrown with the specifed message.

## with Args
````stub$withArgs(a = 1, d = 3)$returns(10)````

If the expected arguements are **part** of the function call, then the specified object will be returned.

````stub$withArgs(a = 1, d = 3)$throws('err msg')````

If the expected arguements are **part** of the function call,  then an error is thrown with the specifed message.

## onCall
````stub$onCall(2)$returns(10)````

When the function is called the nth time, the specified object will be returned.

````stub$onCall(2)$throws('err_msg')````

When the function is called the nth time, error is thrown with the specifed message.

  
*onCall* can be used along with *withExactArgs* and *withArgs*.

```
stub$onCall(3)$withExactArgs(a = 1, b = 2, d = 3, c = 4)$returns(10)
stub$onCall(2)$withExactArgs(a = 1, b = 2, d = 3, c = 4)$throws('err_msg')
stub$onCall(3)$withArgs(a = 1, d = 3)$returns(10)
stub$onCall(3)$withArgs(a = 1, d = 3)$throws('err msg')
```

# Caveats
All arguments must be named.

```stub_builder$withArgs(1)$return(T)``` won't work.

```stub_builder$withArgs(x = 1)$return(T)``` will work.
